登录鉴权与权限控制（React）

没啥好说的，基本功能，就看怎么封装的优雅些。

<!-- more -->

## 价值
权限控制的核心在于后端，那么前端需要提供权限控制（假的）吗，当然需要。

前端权限控制的价值有
* 提升突破权限的门槛
* 过滤越权请求，减轻服务端压力
* 提升用户体验

## 常见场景
大致由如下几类
* 是否登录：对于受保护的资源，当用户没有登录时则直接跳转到登录页要求用户登录。
* 角色控制：即使都是登录用户，但角色不同，权限也就不同，能看到和操作的东西就会有所差别。

权限不同又可以进一步分为如下场景
* 页面级控制：没有权限的无法进入某个页面
  * 路由菜单不显示
  * 直接 404 该路由
  * 提示 403 状态
* 元素级控制：同一个页面，看到的元素和操作不同
  * 元素直接消失
  * 元素保留，但处于禁用态，同时引导用户购买 Pro 版等

## 基本封装
基本工具
* 提供 AuthClient 类封装 login/logout/getUser 等操作，维护认证相关状态
* 提供 AuthProvider 组件，用于认证相关上下文
* 提供 useAuth 钩子返回 authClient 和 authState（token/isAuthenticated/user）
* 提供 Access 组件，用于页面元素的显示和隐藏的控制
* 提供 useAccess 获取权限定义，返回是否有某权限
* 提供 PrivateRoute 进一步封装原生 Route 组件，用于无权限时显示 404 或 403、或自动跳转登录页

简单权限控制基本原理
1. 定义系统所有的权限点（key）
2. 每个用户根据角色不同，有不同的权限点模板
3. 针对路由或按钮，都有唯一 key 值对应
4. 当需要控制某个路由或按钮时，进行比对即可

大致步骤
* 用户登录：获取 token 并存储在本地，发送请求时自动带上，获取用户信息和权限数据
* 如果直接访问受保护页面，则在最外层路由尝试获取用户信息和权限数据
* 对于路由和视图元素应用权限数据

## 扩展
如果是多个前端服务，需要实现单点登录，可通过 iframe 实现跨域传递数据。

withCredentials 的作用
* 如果遵循同源策略，该属性不会造成任何影响，**永远不会影响到同源请求**
* 要使得该字段生效，服务端必须设置 Access-Control-Allow-Credentials 为 true
* 目的：跨域请求时，cookie 和认证的 HTTP 头信息是否会包含在请求当中，默认为 false，不仅会发送 cookie，还会设置远程主机指定的 Cookie
* 相关注意事项
  * 即使设置为 true，依然遵循同源政策
  * 设置 Access-Control-Allow-Origin 仅表示为允许跨域，是否发送 cookie 还是取决于 withCredentials，因此和 withCredentials 不冲突
  * Cookie 的作用域由 domain 和 path 共同决定

如何解决前端多服务，由于跨域问题导致登录态无法传递问题
* 传统多个服务共用一个登录系统，单点登录利用的是 redirect 到登录系统域名下去换取 ticket 的机制
* 利用 nginx 将多个服务转换到一个服务下，从而规避掉跨域问题，缺点就是开发环境变麻烦，热更新机制会失效
* 利用微前端框架
  * 将多个服务转发到一个服务下
  * 支持一个页面同时显示多个子应用
  * 热更新机制大概率失效
* 利用 iframe + postMessage
* jsonp 机制